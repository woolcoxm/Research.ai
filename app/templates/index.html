<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Research System - Advanced Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-width: 280px;
            --header-height: 70px;
            --deepseek-color: #0066cc;
            --ollama-color: #28a745;
            --system-color: #6f42c1;
            --bg-dark: #1a1d23;
            --bg-darker: #13161a;
            --text-light: #e4e6eb;
            --text-muted: #9ca3af;
            --border-color: #2d3139;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-darker);
            color: var(--text-light);
            overflow-x: hidden;
        }
        
        /* Header */
        .main-header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: var(--bg-dark);
            border-bottom: 2px solid var(--border-color);
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-light);
        }
        
        .header-status {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.active { background: #22c55e; }
        .status-dot.idle { background: #6b7280; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-dark);
            border-right: 2px solid var(--border-color);
            padding: 20px 0;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar-logo {
            padding: 0 20px 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-logo h2 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-nav {
            padding: 0 10px;
        }
        
        .nav-item {
            margin-bottom: 5px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-light);
        }
        
        .nav-link.active {
            background: rgba(0,102,204,0.15);
            color: #4dabf7;
            font-weight: 500;
        }
        
        .nav-icon {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 30px;
            min-height: calc(100vh - var(--header-height));
        }
        
        /* Tab Content */
        .tab-content-section {
            display: none;
        }
        
        .tab-content-section.active {
            display: block;
        }
        
        /* Start Research Section */
        .start-section {
            max-width: 800px;
            margin: 50px auto;
        }
        
        .prompt-card {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid var(--border-color);
        }
        
        .prompt-card h3 {
            margin-bottom: 20px;
            color: var(--text-light);
        }
        
        .prompt-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            background: var(--bg-darker);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1rem;
            resize: vertical;
            font-family: inherit;
        }
        
        .prompt-textarea:focus {
            outline: none;
            border-color: #4dabf7;
        }
        
        .start-button {
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .start-button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .start-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Progress Section */
        .progress-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .progress-card {
            background: var(--bg-dark);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .progress-card-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .progress-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-light);
        }
        
        .progress-card-subtext {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        /* Stage Progress */
        .stages-container {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid var(--border-color);
        }
        
        .stage-item {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            margin-bottom: 15px;
            background: var(--bg-darker);
            border-radius: 10px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .stage-item.completed {
            border-left-color: #22c55e;
            opacity: 0.7;
        }
        
        .stage-item.active {
            border-left-color: #4dabf7;
            background: rgba(77, 171, 247, 0.1);
        }
        
        .stage-item.pending {
            opacity: 0.4;
        }
        
        .stage-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-darker);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 20px;
            flex-shrink: 0;
        }
        
        .stage-item.completed .stage-number {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }
        
        .stage-item.active .stage-number {
            background: #4dabf7;
            border-color: #4dabf7;
            color: white;
            animation: pulse-ring 2s infinite;
        }
        
        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(77, 171, 247, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(77, 171, 247, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(77, 171, 247, 0);
            }
        }
        
        .stage-content {
            flex: 1;
        }
        
        .stage-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .stage-description {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        
        .stage-detail {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: rgba(77, 171, 247, 0.1);
            border-radius: 6px;
            font-size: 0.85rem;
            color: #4dabf7;
        }
        
        .stage-item.active .stage-detail {
            display: block;
        }
        
        .stage-progress-bar {
            display: none;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .stage-item.active .stage-progress-bar {
            display: block;
        }
        
        .stage-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4dabf7, #667eea);
            transition: width 0.3s;
        }
        
        /* Activity Feed */
        .activity-feed {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .activity-feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .activity-feed-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
        }
        
        .clear-feed-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .clear-feed-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
        }
        
        .activity-item {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-darker);
            border-radius: 8px;
            border-left: 3px solid transparent;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .activity-item.deepseek {
            border-left-color: var(--deepseek-color);
        }
        
        .activity-item.ollama {
            border-left-color: var(--ollama-color);
        }
        
        .activity-item.system {
            border-left-color: var(--system-color);
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.2rem;
        }
        
        .activity-item.deepseek .activity-icon {
            background: rgba(0, 102, 204, 0.2);
            color: var(--deepseek-color);
        }
        
        .activity-item.ollama .activity-icon {
            background: rgba(40, 167, 69, 0.2);
            color: var(--ollama-color);
        }
        
        .activity-item.system .activity-icon {
            background: rgba(111, 66, 193, 0.2);
            color: var(--system-color);
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .activity-agent {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-light);
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .activity-action {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 8px;
        }
        
        .activity-details {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.5;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        
        .activity-details.expanded {
            max-height: none;
        }
        
        .expand-details-btn {
            margin-top: 8px;
            padding: 4px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .expand-details-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
        }
        
        /* Conversations Section */
        .conversations-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .conversation-panel {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            max-height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
        }
        
        .conversation-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .conversation-header-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .deepseek-panel .conversation-header-icon {
            background: rgba(0, 102, 204, 0.2);
            color: var(--deepseek-color);
        }
        
        .ollama-panel .conversation-header-icon {
            background: rgba(40, 167, 69, 0.2);
            color: var(--ollama-color);
        }
        
        .conversation-header-text h3 {
            font-size: 1.2rem;
            margin-bottom: 4px;
            color: var(--text-light);
        }
        
        .conversation-header-text p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 0;
        }
        
        .conversation-messages {
            flex: 1;
            overflow-y: auto;
        }
        
        .message-item {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-darker);
            border-radius: 8px;
            border-left: 3px solid transparent;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .deepseek-panel .message-item {
            border-left-color: var(--deepseek-color);
        }
        
        .ollama-panel .message-item {
            border-left-color: var(--ollama-color);
        }
        
        .message-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .message-number {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        .message-timestamp {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .message-content {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-light);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Completion Banner */
        .completion-banner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 60px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            z-index: 10000;
            text-align: center;
            display: none;
        }
        
        .completion-banner.show {
            display: block;
            animation: bounceIn 0.5s;
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .completion-banner h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: white;
        }
        
        .completion-stats {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .completion-stat {
            text-align: center;
        }
        
        .completion-stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
        }
        
        .completion-stat-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
            margin-top: 5px;
        }
        
        .completion-actions {
            margin-top: 30px;
        }
        
        .download-button {
            padding: 12px 30px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s;
        }
        
        .download-button:hover {
            transform: translateY(-2px);
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-darker);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #3d4149;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-header,
            .main-content {
                margin-left: 0;
            }
            
            .conversations-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--text-light);
        }
        
        .empty-state p {
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <h2><i class="fas fa-brain"></i> AI Research</h2>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a class="nav-link active" data-tab="start">
                    <i class="fas fa-rocket nav-icon"></i>
                    <span>Start Research</span>
                </a>
            </div>
            <div class="nav-item">
                <a class="nav-link" data-tab="progress">
                    <i class="fas fa-tasks nav-icon"></i>
                    <span>Progress Tracker</span>
                </a>
            </div>
            <div class="nav-item">
                <a class="nav-link" data-tab="activity">
                    <i class="fas fa-stream nav-icon"></i>
                    <span>Live Activity Feed</span>
                </a>
            </div>
            <div class="nav-item">
                <a class="nav-link" data-tab="conversations">
                    <i class="fas fa-comments nav-icon"></i>
                    <span>LLM Conversations</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Header -->
    <div class="main-header">
        <div class="header-title">AI Research System</div>
        <div class="header-status">
            <div class="status-indicator">
                <div class="status-dot idle" id="systemStatusDot"></div>
                <span id="systemStatusText">System Ready</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Start Research Tab -->
        <div class="tab-content-section active" id="tab-start">
            <div class="start-section">
                <div class="prompt-card">
                    <h3>What would you like to research?</h3>
                    <textarea 
                        class="prompt-textarea" 
                        id="userPrompt" 
                        placeholder="Enter your research prompt here... Be specific about what you want to learn or build. The AI will conduct comprehensive research, analyze 100-200 sources, and generate detailed documentation."
                    ></textarea>
                    <button class="start-button" id="startResearchBtn">
                        <i class="fas fa-rocket"></i> Begin Automated Research
                    </button>
                    
                    <!-- Load Previous Session -->
                    <div style="margin-top: 30px; padding-top: 30px; border-top: 1px solid var(--border-color);">
                        <h4 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--text-muted);">
                            <i class="fas fa-history"></i> Load Previous Session
                        </h4>
                        <div style="display: flex; gap: 10px; align-items: flex-start;">
                            <select class="form-select" id="savedSessionsDropdown" style="flex: 1; background: var(--bg-darker); color: var(--text-light); border: 1px solid var(--border-color); padding: 12px; border-radius: 8px;">
                                <option value="">Select a saved session...</option>
                            </select>
                            <button class="btn btn-outline-primary" id="loadSessionBtn" style="padding: 12px 24px; border-radius: 8px;" disabled>
                                <i class="fas fa-folder-open"></i> Load
                            </button>
                            <button class="btn btn-outline-success" id="resumeSessionBtn" style="padding: 12px 24px; border-radius: 8px; display: none;" disabled>
                                <i class="fas fa-play"></i> Resume
                            </button>
                            <button class="btn btn-outline-danger" id="deleteSessionBtn" style="padding: 12px 24px; border-radius: 8px;" disabled>
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Tracker Tab -->
        <div class="tab-content-section" id="tab-progress">
            <div class="progress-overview">
                <div class="progress-card">
                    <div class="progress-card-label">Current Stage</div>
                    <div class="progress-card-value" id="currentStageText">—</div>
                    <div class="progress-card-subtext" id="currentStageSubtext">Not started</div>
                </div>
                <div class="progress-card">
                    <div class="progress-card-label">Rounds Completed</div>
                    <div class="progress-card-value" id="roundsCompleted">0</div>
                    <div class="progress-card-subtext">of ~30-40 total</div>
                </div>
                <div class="progress-card">
                    <div class="progress-card-label">Sources Analyzed</div>
                    <div class="progress-card-value" id="sourcesAnalyzed">0</div>
                    <div class="progress-card-subtext">research results</div>
                </div>
                <div class="progress-card">
                    <div class="progress-card-label">Messages Exchanged</div>
                    <div class="progress-card-value" id="messagesExchanged">0</div>
                    <div class="progress-card-subtext">LLM communications</div>
                </div>
            </div>

            <div class="stages-container">
                <h3 style="margin-bottom: 25px; color: var(--text-light);">11-Stage Research Pipeline</h3>
                
                <div class="stage-item pending" data-stage="initial_breakdown">
                    <div class="stage-number">1</div>
                    <div class="stage-content">
                        <div class="stage-name">Initial Breakdown</div>
                        <div class="stage-description">DeepSeek analyzes your prompt in depth</div>
                        <div class="stage-detail" id="stage-detail-1">Identifying key concepts and requirements...</div>
                        <div class="stage-progress-bar">
                            <div class="stage-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stage-item pending" data-stage="discuss_breakdown">
                    <div class="stage-number">2</div>
                    <div class="stage-content">
                        <div class="stage-name">Discuss Breakdown</div>
                        <div class="stage-description">LLMs collaborate on research strategy (4 rounds)</div>
                        <div class="stage-detail" id="stage-detail-2">Agreeing on what to research...</div>
                        <div class="stage-progress-bar">
                            <div class="stage-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stage-item pending" data-stage="research">
                    <div class="stage-number">3</div>
                    <div class="stage-content">
                        <div class="stage-name">Execute Research</div>
                        <div class="stage-description">Performing 12-18 web searches</div>
                        <div class="stage-detail" id="stage-detail-3">Gathering information...</div>
                        <div class="stage-progress-bar">
                            <div class="stage-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stage-item pending" data-stage="analyze_research">
                    <div class="stage-number">4</div>
                    <div class="stage-content">
                        <div class="stage-name">Analyze Research</div>
                        <div class="stage-description">DeepSeek processes 100-200 sources</div>
                        <div class="stage-detail" id="stage-detail-4">Analyzing sources...</div>
                        <div class="stage-progress-bar">
                            <div class="stage-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stage-item pending" data-stage="discuss_findings">
                    <div class="stage-number">5</div>
                    <div class="stage-content">
                        <div class="stage-name">Discuss Findings</div>
                        <div class="stage-description">LLMs extract insights (5 rounds)</div>
                        <div class="stage-detail" id="stage-detail-5">Identifying patterns...</div>
                        <div class="stage-progress-bar">
                            <div class="stage-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stage-item pending" data-stage="deep_dive">
                    <div class="stage-number">6</div>
                    <div class="stage-content">
                        <div class="stage-name">Deep Dive</div>
                        <div class="stage-description">Detailed technical analysis (7 rounds + dynamic searches)</div>
                        <div class="stage-detail" id="stage-detail-6">Deep analysis in progress...</div>
                        <div class="stage-progress-bar">
                            <div class="stage-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stage-item pending" data-stage="compile_information">
                    <div class="stage-number">7</div>
                    <div class="stage-content">
                        <div class="stage-name">Compile Information</div>
                        <div class="stage-description">DeepSeek uses full 128K context to compile everything</div>
                        <div class="stage-detail" id="stage-detail-7">Creating master compilation...</div>
                        <div class="stage-progress-bar">
                            <div class="stage-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stage-item pending" data-stage="discuss_compilation">
                    <div class="stage-number">8</div>
                    <div class="stage-content">
                        <div class="stage-name">Discuss Compilation</div>
                        <div class="stage-description">LLMs validate completeness (4 rounds)</div>
                        <div class="stage-detail" id="stage-detail-8">Reviewing compilation...</div>
                        <div class="stage-progress-bar">
                            <div class="stage-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stage-item pending" data-stage="generate_documents">
                    <div class="stage-number">9</div>
                    <div class="stage-content">
                        <div class="stage-name">Generate Documents</div>
                        <div class="stage-description">Creating 1-7 specialized markdown documents</div>
                        <div class="stage-detail" id="stage-detail-9">Generating documentation...</div>
                        <div class="stage-progress-bar">
                            <div class="stage-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stage-item pending" data-stage="refine_documents">
                    <div class="stage-number">10</div>
                    <div class="stage-content">
                        <div class="stage-name">Refine Documents</div>
                        <div class="stage-description">LLMs polish each document until perfect</div>
                        <div class="stage-detail" id="stage-detail-10">Refining documentation...</div>
                        <div class="stage-progress-bar">
                            <div class="stage-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stage-item pending" data-stage="completed">
                    <div class="stage-number">11</div>
                    <div class="stage-content">
                        <div class="stage-name">Completed</div>
                        <div class="stage-description">Research complete - documents ready for download</div>
                        <div class="stage-detail" id="stage-detail-11">All done!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Activity Feed Tab -->
        <div class="tab-content-section" id="tab-activity">
            <div class="activity-feed">
                <div class="activity-feed-header">
                    <div class="activity-feed-title">
                        <i class="fas fa-rss"></i> Live Activity Feed
                    </div>
                    <button class="clear-feed-btn" onclick="clearActivityFeed()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
                <div id="activityFeedContent">
                    <div class="empty-state">
                        <i class="fas fa-stream"></i>
                        <h3>No Activity Yet</h3>
                        <p>Start a research session to see real-time updates</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- LLM Conversations Tab -->
        <div class="tab-content-section" id="tab-conversations">
            <div class="conversations-container">
                <div class="conversation-panel deepseek-panel">
                    <div class="conversation-header">
                        <div class="conversation-header-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="conversation-header-text">
                            <h3>DeepSeek</h3>
                            <p>128K context • Deep analysis & synthesis</p>
                        </div>
                    </div>
                    <div class="conversation-messages" id="deepseekMessages">
                        <div class="empty-state">
                            <i class="fas fa-comment"></i>
                            <h3>No Messages Yet</h3>
                            <p>DeepSeek's responses will appear here</p>
                        </div>
                    </div>
                </div>

                <div class="conversation-panel ollama-panel">
                    <div class="conversation-header">
                        <div class="conversation-header-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="conversation-header-text">
                            <h3>Ollama</h3>
                            <p>32K context • Critical review & validation</p>
                        </div>
                    </div>
                    <div class="conversation-messages" id="ollamaMessages">
                        <div class="empty-state">
                            <i class="fas fa-comment"></i>
                            <h3>No Messages Yet</h3>
                            <p>Ollama's responses will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Completion Banner -->
    <div class="completion-banner" id="completionBanner">
        <h2><i class="fas fa-check-circle"></i> Research Complete!</h2>
        <div class="completion-stats">
            <div class="completion-stat">
                <div class="completion-stat-value" id="completionMessages">0</div>
                <div class="completion-stat-label">Messages</div>
            </div>
            <div class="completion-stat">
                <div class="completion-stat-value" id="completionSearches">0</div>
                <div class="completion-stat-label">Searches</div>
            </div>
            <div class="completion-stat">
                <div class="completion-stat-value" id="completionDocuments">0</div>
                <div class="completion-stat-label">Documents</div>
            </div>
        </div>
        <div class="completion-actions">
            <button class="download-button" onclick="downloadDocuments()">
                <i class="fas fa-download"></i> Download All Documents
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentSessionId = null;
        let isResearchActive = false;
        let statusInterval = null;
        let activityFeedItems = [];
        let deepseekMessageCount = 0;
        let ollamaMessageCount = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupNavigation();
            setupStartButton();
            checkSystemStatus();
            loadSavedSessions();
            setupSessionControls();
        });

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                });
            });
        }

        function switchTab(tabName) {
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.nav-link[data-tab="${tabName}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Start Research
        function setupStartButton() {
            const btn = document.getElementById('startResearchBtn');
            const textarea = document.getElementById('userPrompt');

            textarea.addEventListener('input', function() {
                btn.disabled = this.value.trim().length === 0;
            });

            btn.addEventListener('click', startResearch);
        }

        async function startResearch() {
            const prompt = document.getElementById('userPrompt').value.trim();
            if (!prompt) return;

            const btn = document.getElementById('startResearchBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Starting Research...';

            try {
                const response = await fetch('/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                const data = await response.json();
                
                if (data.session_id) {
                    currentSessionId = data.session_id;
                    isResearchActive = true;
                    
                    // Update UI
                    document.getElementById('systemStatusDot').classList.remove('idle');
                    document.getElementById('systemStatusDot').classList.add('active');
                    document.getElementById('systemStatusText').textContent = 'Research Active';
                    
                    // Switch to progress tab
                    switchTab('progress');
                    
                    // Start polling
                    startStatusPolling();
                    startConversationPolling();
                    
                    // Show initial activity
                    addActivityItem('System', 'Research session started', 'Initializing 11-stage workflow', 'system');
                }
            } catch (error) {
                console.error('Failed to start research:', error);
                btn.innerHTML = '<i class="fas fa-rocket"></i> Begin Automated Research';
                btn.disabled = false;
            }
        }

        // System Status
        async function checkSystemStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                if (data.system_initialized) {
                    console.log('System ready');
                }
            } catch (error) {
                console.error('Failed to check system status:', error);
            }
        }

        // Status Polling
        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            
            statusInterval = setInterval(async () => {
                if (!currentSessionId || !isResearchActive) return;
                
                try {
                    const response = await fetch(`/status/${currentSessionId}`);
                    const data = await response.json();
                    
                    if (data.status) {
                        updateStatusFromData(data);
                    }
                    
                    if (data.session) {
                        updateProgressFromSession(data.session);
                        
                        // Check for completion
                        if (data.session.completed || data.session.current_stage === 'completed') {
                            isResearchActive = false;
                            clearInterval(statusInterval);
                            showCompletionBanner(data.session);
                        }
                    }
                } catch (error) {
                    console.error('Status polling error:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        function updateStatusFromData(data) {
            const { status, session } = data;
            
            if (status) {
                // Add to activity feed
                addActivityItem(
                    status.llm_name,
                    status.activity,
                    status.details,
                    status.llm_name.toLowerCase()
                );
                
                // Update stage detail
                if (session && session.current_stage) {
                    const stageNumber = getStageNumber(session.current_stage);
                    if (stageNumber) {
                        const detailDiv = document.getElementById(`stage-detail-${stageNumber}`);
                        if (detailDiv) {
                            detailDiv.textContent = status.activity + (status.details ? ': ' + status.details.substring(0, 100) : '');
                        }
                    }
                }
            }
        }

        function updateProgressFromSession(session) {
            // Update overview cards
            document.getElementById('currentStageText').textContent = formatStageName(session.current_stage);
            document.getElementById('currentStageSubtext').textContent = 'Stage ' + getStageNumber(session.current_stage) + ' of 11';
            document.getElementById('roundsCompleted').textContent = session.conversation_round || 0;
            document.getElementById('sourcesAnalyzed').textContent = session.search_count || 0;
            document.getElementById('messagesExchanged').textContent = session.message_count || 0;
            
            // Update stage progress
            updateStageUI(session.current_stage);
        }

        function updateStageUI(currentStage) {
            const stages = [
                'initial_breakdown', 'discuss_breakdown', 'research', 'analyze_research',
                'discuss_findings', 'deep_dive', 'compile_information', 'discuss_compilation',
                'generate_documents', 'refine_documents', 'completed'
            ];
            
            let foundCurrent = false;
            
            stages.forEach(stage => {
                const item = document.querySelector(`.stage-item[data-stage="${stage}"]`);
                if (!item) return;
                
                if (stage === currentStage) {
                    item.classList.remove('pending', 'completed');
                    item.classList.add('active');
                    foundCurrent = true;
                } else if (!foundCurrent) {
                    item.classList.remove('pending', 'active');
                    item.classList.add('completed');
                    const number = item.querySelector('.stage-number');
                    number.innerHTML = '<i class="fas fa-check"></i>';
                } else {
                    item.classList.remove('active', 'completed');
                    item.classList.add('pending');
                }
            });
        }

        // Activity Feed
        function addActivityItem(agent, action, details, type = 'system') {
            const feedContent = document.getElementById('activityFeedContent');
            
            // Remove empty state if present
            const emptyState = feedContent.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const item = document.createElement('div');
            item.className = `activity-item ${type}`;
            
            const icon = getAgentIcon(agent);
            const time = new Date().toLocaleTimeString();
            
            const detailsPreview = details.length > 200 ? details.substring(0, 200) + '...' : details;
            const showExpand = details.length > 200;
            
            item.innerHTML = `
                <div class="activity-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-header">
                        <div class="activity-agent">${agent}</div>
                        <div class="activity-time">${time}</div>
                    </div>
                    <div class="activity-action">${action}</div>
                    ${details ? `
                        <div class="activity-details" id="details-${Date.now()}">
                            ${detailsPreview}
                        </div>
                        ${showExpand ? `
                            <button class="expand-details-btn" onclick="toggleDetails(this)">
                                <i class="fas fa-chevron-down"></i> Show More
                            </button>
                        ` : ''}
                    ` : ''}
                </div>
            `;
            
            // Store full details
            if (showExpand) {
                item.dataset.fullDetails = details;
            }
            
            feedContent.insertBefore(item, feedContent.firstChild);
            
            // Limit to 100 items
            const items = feedContent.querySelectorAll('.activity-item');
            if (items.length > 100) {
                items[items.length - 1].remove();
            }
        }

        function toggleDetails(btn) {
            const item = btn.closest('.activity-item');
            const detailsDiv = item.querySelector('.activity-details');
            const isExpanded = detailsDiv.classList.contains('expanded');
            
            if (isExpanded) {
                const preview = item.dataset.fullDetails.substring(0, 200) + '...';
                detailsDiv.textContent = preview;
                detailsDiv.classList.remove('expanded');
                btn.innerHTML = '<i class="fas fa-chevron-down"></i> Show More';
            } else {
                detailsDiv.textContent = item.dataset.fullDetails;
                detailsDiv.classList.add('expanded');
                btn.innerHTML = '<i class="fas fa-chevron-up"></i> Show Less';
            }
        }

        function clearActivityFeed() {
            const feedContent = document.getElementById('activityFeedContent');
            feedContent.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-stream"></i>
                    <h3>Activity Feed Cleared</h3>
                    <p>New activities will appear here</p>
                </div>
            `;
        }

        // Conversations Polling
        function startConversationPolling() {
            setInterval(async () => {
                if (!currentSessionId) return;
                
                try {
                    const response = await fetch(`/conversations/${currentSessionId}`);
                    const data = await response.json();
                    
                    if (data.deepseek_messages) {
                        updateConversationPanel('deepseek', data.deepseek_messages);
                    }
                    
                    if (data.ollama_messages) {
                        updateConversationPanel('ollama', data.ollama_messages);
                    }
                } catch (error) {
                    console.error('Conversation polling error:', error);
                }
            }, 3000); // Poll every 3 seconds
        }

        function updateConversationPanel(type, messages) {
            const container = document.getElementById(`${type}Messages`);
            
            if (messages.length === 0) return;
            
            // Remove empty state
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            // Clear and rebuild
            container.innerHTML = '';
            
            messages.forEach((msg, index) => {
                const item = document.createElement('div');
                item.className = 'message-item';
                
                const timestamp = new Date(msg.timestamp).toLocaleTimeString();
                // Show full content - scrollbar handles long messages
                const content = msg.content;
                
                item.innerHTML = `
                    <div class="message-meta">
                        <div class="message-number">Message #${index + 1}</div>
                        <div class="message-timestamp">${timestamp}</div>
                    </div>
                    <div class="message-content">${content}</div>
                `;
                
                container.appendChild(item);
            });
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Completion Banner
        function showCompletionBanner(sessionData) {
            document.getElementById('systemStatusDot').classList.remove('active');
            document.getElementById('systemStatusDot').classList.add('idle');
            document.getElementById('systemStatusText').textContent = 'Completed';
            
            const banner = document.getElementById('completionBanner');
            document.getElementById('completionMessages').textContent = sessionData.message_count || 0;
            document.getElementById('completionSearches').textContent = sessionData.search_count || 0;
            document.getElementById('completionDocuments').textContent = Object.keys(sessionData.saved_files || {}).length;
            
            banner.classList.add('show');
            
            // Auto hide after 10 seconds
            setTimeout(() => {
                banner.classList.remove('show');
            }, 10000);
        }

        function downloadDocuments() {
            if (currentSessionId) {
                window.location.href = `/session/${currentSessionId}`;
            }
        }

        // Helper Functions
        function getAgentIcon(agent) {
            const icons = {
                'DeepSeek': 'fas fa-brain',
                'Ollama': 'fas fa-robot',
                'System': 'fas fa-cog'
            };
            return icons[agent] || 'fas fa-info-circle';
        }

        function formatStageName(stage) {
            const names = {
                'initial_breakdown': 'Initial Breakdown',
                'discuss_breakdown': 'Discuss Breakdown',
                'research': 'Research',
                'analyze_research': 'Analyze Research',
                'discuss_findings': 'Discuss Findings',
                'deep_dive': 'Deep Dive',
                'compile_information': 'Compile Information',
                'discuss_compilation': 'Discuss Compilation',
                'generate_documents': 'Generate Documents',
                'refine_documents': 'Refine Documents',
                'completed': 'Completed'
            };
            return names[stage] || stage;
        }

        function getStageNumber(stage) {
            const stages = {
                'initial_breakdown': 1,
                'discuss_breakdown': 2,
                'research': 3,
                'analyze_research': 4,
                'discuss_findings': 5,
                'deep_dive': 6,
                'compile_information': 7,
                'discuss_compilation': 8,
                'generate_documents': 9,
                'refine_documents': 10,
                'completed': 11
            };
            return stages[stage] || null;
        }

        // Session Management Functions
        async function loadSavedSessions() {
            try {
                const response = await fetch('/sessions/list');
                const data = await response.json();
                
                const dropdown = document.getElementById('savedSessionsDropdown');
                dropdown.innerHTML = '<option value="">Select a saved session...</option>';
                
                if (data.sessions && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.session_id;
                        const savedDate = new Date(session.saved_at).toLocaleString();
                        const query = session.query.substring(0, 60) + (session.query.length > 60 ? '...' : '');
                        option.textContent = `${savedDate} - ${query}`;
                        dropdown.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load saved sessions:', error);
            }
        }

        function setupSessionControls() {
            const dropdown = document.getElementById('savedSessionsDropdown');
            const loadBtn = document.getElementById('loadSessionBtn');
            const resumeBtn = document.getElementById('resumeSessionBtn');
            const deleteBtn = document.getElementById('deleteSessionBtn');

            dropdown.addEventListener('change', function() {
                const hasSelection = this.value !== '';
                loadBtn.disabled = !hasSelection;
                deleteBtn.disabled = !hasSelection;
                resumeBtn.style.display = 'none'; // Hide resume until session is loaded
            });

            loadBtn.addEventListener('click', async function() {
                const sessionId = dropdown.value;
                if (!sessionId) return;

                try {
                    const response = await fetch(`/sessions/restore/${sessionId}`, {
                        method: 'POST'
                    });
                    const data = await response.json();

                    if (data.session_id) {
                        currentSessionId = data.session_id;
                        
                        // CRITICAL: Set research as active so polling works
                        isResearchActive = data.can_resume; // Only active if can resume
                        
                        // Update UI status indicator
                        if (data.can_resume) {
                            document.getElementById('systemStatusDot').classList.remove('idle');
                            document.getElementById('systemStatusDot').classList.add('active');
                            document.getElementById('systemStatusText').textContent = 'Session Restored';
                        }
                        
                        // Show resume button if session can be resumed
                        if (data.can_resume) {
                            resumeBtn.style.display = 'inline-block';
                            resumeBtn.disabled = false;
                        }
                        
                        // Switch to progress tab and start polling
                        switchTab('progress');
                        
                        // CRITICAL: Force an immediate status fetch to populate UI
                        if (data.can_resume) {
                            const statusResponse = await fetch(`/status/${currentSessionId}`);
                            const statusData = await statusResponse.json();
                            if (statusData.session) {
                                updateProgressFromSession(statusData.session);
                            }
                        }
                        
                        startStatusPolling();
                        startConversationPolling();
                        
                        const statusMsg = data.can_resume 
                            ? `Session restored at stage ${data.session_data.current_stage} (round ${data.session_data.conversation_round}). Click Resume to continue.`
                            : 'Session restored successfully!';
                        alert(statusMsg);
                    }
                } catch (error) {
                    console.error('Failed to restore session:', error);
                    alert('Failed to restore session');
                }
            });

            resumeBtn.addEventListener('click', async function() {
                if (!currentSessionId) return;

                if (!confirm('Resume this session from where it left off?')) return;

                try {
                    const response = await fetch(`/sessions/resume/${currentSessionId}`, {
                        method: 'POST'
                    });
                    const data = await response.json();

                    if (data.session_id) {
                        // CRITICAL: Set research as active so polling continues
                        isResearchActive = true;
                        
                        // Update UI status indicator
                        document.getElementById('systemStatusDot').classList.remove('idle');
                        document.getElementById('systemStatusDot').classList.add('active');
                        document.getElementById('systemStatusText').textContent = 'Research Active';
                        
                        // Hide resume button and switch to progress
                        resumeBtn.style.display = 'none';
                        switchTab('progress');
                        
                        // Add activity item
                        addActivityItem('System', `Resuming from stage ${data.current_stage}`, 
                                      `Continuing from round ${data.conversation_round}`, 'system');
                        
                        alert(`Session resumed from stage ${data.current_stage}`);
                    }
                } catch (error) {
                    console.error('Failed to resume session:', error);
                    alert('Failed to resume session');
                }
            });

            deleteBtn.addEventListener('click', async function() {
                const sessionId = dropdown.value;
                if (!sessionId) return;

                if (!confirm('Are you sure you want to delete this session?')) return;

                try {
                    const response = await fetch(`/sessions/delete/${sessionId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('Session deleted successfully');
                        loadSavedSessions(); // Refresh the list
                    }
                } catch (error) {
                    console.error('Failed to delete session:', error);
                    alert('Failed to delete session');
                }
            });
        }
    </script>
</body>
</html>
