<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Research System - Live Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Main Dashboard Styles */
        .dashboard-container { 
            min-height: 100vh; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 0;
        }
        
        .main-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Live Status Panel */
        .status-panel {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-active { background-color: #00ff88; }
        .status-thinking { background-color: #ffaa00; }
        .status-idle { background-color: #666; }
        .status-complete { background-color: #00aa00; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* LLM Status Cards */
        .llm-status-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 5px solid #ddd;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .llm-status-card.deepseek {
            border-left-color: #007bff;
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
        }
        
        .llm-status-card.ollama {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #e8f5e8 0%, #ffffff 100%);
        }
        
        .llm-status-card.system {
            border-left-color: #6f42c1;
            background: linear-gradient(135deg, #f3e5f5 0%, #ffffff 100%);
        }
        
        .llm-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .llm-avatar.deepseek { background: #007bff; }
        .llm-avatar.ollama { background: #28a745; }
        .llm-avatar.system { background: #6f42c1; }
        
        /* Progress and Metrics */
        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .metric-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        
        /* Conversation Flow */
        .conversation-flow {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .conversation-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .conversation-item.deepseek { border-left-color: #007bff; }
        .conversation-item.ollama { border-left-color: #28a745; }
        .conversation-item.system { border-left-color: #6f42c1; }
        
        /* Conversation List Styles */
        .conversation-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .message-item {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .message-item:hover {
            background: #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }
        
        .message-item.deepseek {
            border-left-color: #007bff;
        }
        
        .message-item.ollama {
            border-left-color: #28a745;
        }
        
        .message-number {
            display: inline-block;
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .message-number.ollama {
            background: #28a745;
        }
        
        .message-timestamp {
            color: #6c757d;
            font-size: 11px;
            margin-left: 10px;
        }
        
        .message-preview {
            margin: 5px 0 0 38px;
            font-size: 13px;
            color: #495057;
            line-height: 1.4;
        }
        
        /* Message Modal */
        .message-full-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 14px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Activity Timeline */
        .activity-timeline {
            position: relative;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 30px;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #007bff;
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 14px;
            top: 15px;
            width: 2px;
            height: calc(100% + 10px);
            background: #dee2e6;
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        /* Button Styles */
        .btn-primary-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* Document Generation Status */
        .document-status {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .document-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .document-status-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container { padding: 10px; }
            .status-panel { padding: 15px; }
            .metric-number { font-size: 1.5rem; }
        }
        
        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Legacy styles for backward compatibility */
        .message-deepseek { border-left: 4px solid #007bff; background-color: #f8f9fa; }
        .message-ollama { border-left: 4px solid #28a745; background-color: #f8f9fa; }
        
        /* Stage Progress Indicator */
        .stage-progress {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stage-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .stage-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            background: #e9ecef;
            color: #6c757d;
        }
        
        .stage-item.active {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border-left: 4px solid #007bff;
        }
        
        .stage-item.active .stage-number {
            background: #007bff;
            color: white;
            animation: pulse 2s infinite;
        }
        
        .stage-item.completed {
            background: #f8f9fa;
        }
        
        .stage-item.completed .stage-number {
            background: #28a745;
            color: white;
        }
        
        .stage-item.completed .stage-number i {
            display: block;
        }
        
        .stage-name {
            font-weight: 600;
            color: #333;
        }
        
        .stage-description {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="container-fluid">
            <!-- Main Dashboard Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="main-card">
                        <div class="status-panel">
                            <h2><i class="fas fa-brain me-2"></i>AI Research System - Live Dashboard</h2>
                            <p class="mb-1">Real-time monitoring of LLM research and development planning</p>
                            <p class="mb-0 small opacity-75"><i class="fas fa-rocket me-1"></i>New: 11-stage iterative workflow with DeepSeek's 128K context | 100-200 sources analyzed | 1-7 specialized documents</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Status Row -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="main-card">
                        <div id="liveStatusPanel" class="p-4">
                            <h4><i class="fas fa-activity me-2"></i>Live System Status</h4>
                            <div id="currentStatus" class="status-panel">
                                <div class="d-flex align-items-center">
                                    <span class="status-indicator status-idle"></span>
                                    <span id="statusText">System Ready - Enter a prompt to begin research</span>
                                </div>
                                <div id="statusDetails" class="mt-2 small opacity-75"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completion Banner (shown when research is complete) -->
            <div class="row mb-4" id="completionBanner" style="display: none;">
                <div class="col-12">
                    <div class="alert alert-success border-0 shadow-lg fade-in" style="background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); color: white;">
                        <div class="d-flex align-items-center">
                            <div style="font-size: 3rem; margin-right: 20px;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h3 class="mb-2"><i class="fas fa-flag-checkered me-2"></i>Research Complete!</h3>
                                <p class="mb-2" id="completionSummary">Your comprehensive research and development plan is ready.</p>
                                <div class="d-flex gap-4 mt-3">
                                    <div>
                                        <strong id="completionMessages">0</strong> total messages exchanged
                                    </div>
                                    <div>
                                        <strong id="completionSearches">0</strong> research queries
                                    </div>
                                    <div>
                                        <strong id="completionDocuments">0</strong> documents generated
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="main-card">
                        <div class="p-4">
                            <h4><i class="fas fa-keyboard me-2"></i>Research Request</h4>
                            <div class="input-group mb-3">
                                <input type="text" 
                                       id="promptInput" 
                                       class="form-control form-control-lg" 
                                       placeholder="Enter your project idea or research topic..."
                                       onkeypress="if(event.key==='Enter') startResearch()">
                                <button class="btn btn-primary-custom" 
                                        id="startBtn" 
                                        onclick="startResearch()">
                                    <i class="fas fa-search me-2"></i>Start Research
                                </button>
                            </div>
                            <div id="inputHelp" class="form-text">
                                Example: "Build a real-time chat application with React and Node.js"
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LLM Status Cards Row -->
            <div class="row mb-4" id="llmStatusRow" style="display: none;">
                <div class="col-md-4">
                    <div class="llm-status-card deepseek" id="deepseekStatus">
                        <div class="d-flex align-items-center">
                            <div class="llm-avatar deepseek">DS</div>
                            <div>
                                <h6 class="mb-1">DeepSeek</h6>
                                <div class="status-text small text-muted">Strategy & Architecture</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="activity-text small">Idle</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="llm-status-card ollama" id="ollamaStatus">
                        <div class="d-flex align-items-center">
                            <div class="llm-avatar ollama">OL</div>
                            <div>
                                <h6 class="mb-1">Ollama</h6>
                                <div class="status-text small text-muted">Implementation & Review</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="activity-text small">Idle</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="llm-status-card system" id="systemStatus">
                        <div class="d-flex align-items-center">
                            <div class="llm-avatar system">SYS</div>
                            <div>
                                <h6 class="mb-1">System</h6>
                                <div class="status-text small text-muted">Research & Coordination</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="activity-text small">Idle</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stage Progress Indicator -->
            <div class="row mb-4" id="stageProgressRow" style="display: none;">
                <div class="col-12">
                    <div class="main-card">
                        <div class="stage-progress">
                            <h5><i class="fas fa-tasks me-2"></i>Workflow Progress - DeepSeek-Powered Research</h5>
                            <div id="stageProgressContainer">
                                <div class="stage-item" data-stage="initial_breakdown">
                                    <div class="stage-number">1</div>
                                    <div>
                                        <div class="stage-name">Initial Breakdown</div>
                                        <div class="stage-description">DeepSeek analyzes prompt deeply</div>
                                    </div>
                                </div>
                                <div class="stage-item" data-stage="discuss_breakdown">
                                    <div class="stage-number">2</div>
                                    <div>
                                        <div class="stage-name">Discuss Breakdown</div>
                                        <div class="stage-description">LLMs decide what to research</div>
                                    </div>
                                </div>
                                <div class="stage-item" data-stage="research">
                                    <div class="stage-number">3</div>
                                    <div style="flex: 1;">
                                        <div class="stage-name">Research</div>
                                        <div class="stage-description">Execute 12-18 search queries</div>
                                        <div class="stage-progress-detail" style="display: none; margin-top: 8px; padding: 8px; background: rgba(0,123,255,0.1); border-radius: 4px; font-size: 0.85rem;"></div>
                                    </div>
                                </div>
                                <div class="stage-item" data-stage="analyze_research">
                                    <div class="stage-number">4</div>
                                    <div style="flex: 1;">
                                        <div class="stage-name">Analyze Research</div>
                                        <div class="stage-description">DeepSeek analyzes 100-200 sources</div>
                                        <div class="stage-progress-detail" style="display: none; margin-top: 8px; padding: 8px; background: rgba(0,123,255,0.1); border-radius: 4px; font-size: 0.85rem;"></div>
                                    </div>
                                </div>
                                <div class="stage-item" data-stage="discuss_findings">
                                    <div class="stage-number">5</div>
                                    <div>
                                        <div class="stage-name">Discuss Findings</div>
                                        <div class="stage-description">LLMs extract key insights</div>
                                    </div>
                                </div>
                                <div class="stage-item" data-stage="deep_dive">
                                    <div class="stage-number">6</div>
                                    <div style="flex: 1;">
                                        <div class="stage-name">Deep Dive</div>
                                        <div class="stage-description">Detailed analysis + dynamic searches</div>
                                        <div class="stage-progress-detail" style="display: none; margin-top: 8px; padding: 8px; background: rgba(0,123,255,0.1); border-radius: 4px; font-size: 0.85rem;"></div>
                                    </div>
                                </div>
                                <div class="stage-item" data-stage="compile_information">
                                    <div class="stage-number">7</div>
                                    <div>
                                        <div class="stage-name">Compile Information</div>
                                        <div class="stage-description">DeepSeek uses full 128K context</div>
                                    </div>
                                </div>
                                <div class="stage-item" data-stage="discuss_compilation">
                                    <div class="stage-number">8</div>
                                    <div>
                                        <div class="stage-name">Discuss Compilation</div>
                                        <div class="stage-description">LLMs validate completeness</div>
                                    </div>
                                </div>
                                <div class="stage-item" data-stage="generate_documents">
                                    <div class="stage-number">9</div>
                                    <div>
                                        <div class="stage-name">Generate Documents</div>
                                        <div class="stage-description">Create 1-7 specialized docs</div>
                                    </div>
                                </div>
                                <div class="stage-item" data-stage="refine_documents">
                                    <div class="stage-number">10</div>
                                    <div>
                                        <div class="stage-name">Refine Documents</div>
                                        <div class="stage-description">Iterative refinement until perfect</div>
                                    </div>
                                </div>
                                <div class="stage-item" data-stage="completed">
                                    <div class="stage-number">11</div>
                                    <div>
                                        <div class="stage-name">Completed</div>
                                        <div class="stage-description">Download your documents!</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress and Metrics Row -->
            <div class="row mb-4" id="progressRow" style="display: none;">
                <div class="col-12">
                    <div class="main-card">
                        <div class="progress-container">
                            <h5><i class="fas fa-chart-line me-2"></i>Research Progress</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="metric-card">
                                        <div class="metric-number" id="roundCounter">0</div>
                                        <div class="small text-muted">Conversation Rounds</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card">
                                        <div class="metric-number" id="searchCounter">0</div>
                                        <div class="small text-muted">Research Queries</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card">
                                        <div class="metric-number" id="messageCounter">0</div>
                                        <div class="small text-muted">LLM Messages</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card">
                                        <div class="metric-number" id="qualityScore">0%</div>
                                        <div class="small text-muted">Quality Score</div>
                                    </div>
                                </div>
                            </div>
                            <div class="progress mt-3" style="height: 10px;">
                                <div class="progress-bar" id="overallProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Timeline -->
            <div class="row mb-4" id="timelineRow" style="display: none;">
                <div class="col-md-12">
                    <div class="main-card">
                        <div class="p-4">
                            <h5><i class="fas fa-history me-2"></i>Activity Timeline</h5>
                            <div class="activity-timeline" id="activityTimeline">
                                <!-- Timeline items will be added dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversation History -->
            <div class="row mb-4" id="conversationRow" style="display: none;">
                <div class="col-md-6">
                    <div class="main-card">
                        <div class="p-4">
                            <h5><i class="fas fa-robot me-2 text-primary"></i>DeepSeek Messages</h5>
                            <div class="conversation-list" id="deepseekMessages">
                                <p class="text-muted small">No messages yet</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="main-card">
                        <div class="p-4">
                            <h5><i class="fas fa-brain me-2 text-success"></i>Ollama Messages</h5>
                            <div class="conversation-list" id="ollamaMessages">
                                <p class="text-muted small">No messages yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document Generation Status -->
            <div class="row mb-4" id="documentRow" style="display: none;">
                <div class="col-12">
                    <div class="main-card">
                        <div class="document-status">
                            <h5><i class="fas fa-file-alt me-2"></i>Document Generation</h5>
                            <div id="documentList">
                                <!-- Document items will be added dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="row" id="resultsSection" style="display: none;">
                <div class="col-12">
                    <div class="main-card">
                        <div class="p-4">
                            <h4><i class="fas fa-download me-2"></i>Generated Documents</h4>
                            <div id="results">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messageModalLabel">
                        <i class="fas fa-message me-2"></i>Message Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>From:</strong> <span id="modalLLMName"></span><br>
                        <strong>Time:</strong> <span id="modalTimestamp"></span><br>
                        <strong>Message #:</strong> <span id="modalMessageNumber"></span>
                    </div>
                    <hr>
                    <div class="message-full-content" id="modalMessageContent">
                        <!-- Full message content will be displayed here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let currentSessionId = null;
        let statusInterval = null;
        let isResearchActive = false;
        
        // Status update functions
        function updateLiveStatus(llmName, activity, details = '') {
            const statusText = document.getElementById('statusText');
            const statusDetails = document.getElementById('statusDetails');
            const statusIndicator = document.querySelector('.status-indicator');
            
            // Update main status
            statusText.textContent = `${llmName}: ${activity}`;
            statusDetails.textContent = details;
            
            // Update status indicator
            statusIndicator.className = 'status-indicator ' + 
                (llmName === 'System' && activity.includes('Completed') ? 'status-complete' : 
                 llmName === 'System' ? 'status-active' : 'status-thinking');
            
            // Update individual LLM status cards
            updateLLMStatusCard(llmName, activity, details);
            
            // Add to timeline
            addTimelineItem(llmName, activity, details);
        }
        
        function updateLLMStatusCard(llmName, activity, details) {
            let cardId;
            if (llmName === 'DeepSeek') cardId = 'deepseekStatus';
            else if (llmName === 'Ollama') cardId = 'ollamaStatus';
            else cardId = 'systemStatus';
            
            const card = document.getElementById(cardId);
            if (card) {
                const activityText = card.querySelector('.activity-text');
                if (activityText) {
                    activityText.innerHTML = `<strong>${activity}</strong>${details ? '<br><small>' + details + '</small>' : ''}`;
                }
                
                // Add visual indicator
                card.style.transform = 'scale(1.02)';
                card.style.boxShadow = '0 5px 20px rgba(0,0,0,0.15)';
                
                setTimeout(() => {
                    card.style.transform = 'scale(1)';
                    card.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                }, 500);
            }
        }
        
        function addTimelineItem(llmName, activity, details) {
            const timeline = document.getElementById('activityTimeline');
            const timeString = new Date().toLocaleTimeString();
            
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item fade-in';
            timelineItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${llmName}</strong>: ${activity}
                        ${details ? `<br><small class="text-muted">${details}</small>` : ''}
                    </div>
                    <small class="text-muted">${timeString}</small>
                </div>
            `;
            
            timeline.insertBefore(timelineItem, timeline.firstChild);
            
            // Limit timeline items
            while (timeline.children.length > 10) {
                timeline.removeChild(timeline.lastChild);
            }
        }
        
        function addConversationItem(llmType, content, timestamp) {
            // This function is deprecated - conversations are now loaded via loadConversations()
            // We keep it here to prevent errors from old code paths, but it does nothing
            console.log('Note: addConversationItem called but is deprecated. Use loadConversations() instead.');
        }
        
        function updateMetrics(data) {
            const session = data.session || {};
            
            document.getElementById('roundCounter').textContent = session.conversation_round || 0;
            document.getElementById('searchCounter').textContent = session.search_count || 0;
            document.getElementById('messageCounter').textContent = session.message_count || 0;
            
            const qualityScore = Math.round((session.context_maturity || 0) * 100);
            document.getElementById('qualityScore').textContent = qualityScore + '%';
            
            // Update progress bar
            const progress = Math.min(100, (session.conversation_round || 0) * 4); // Assume 25 rounds max
            document.getElementById('overallProgress').style.width = progress + '%';
            document.getElementById('overallProgress').className = `progress-bar ${progress > 80 ? 'bg-success' : progress > 50 ? 'bg-warning' : 'bg-info'}`;
        }
        
        function updateDocumentStatus(documents) {
            const documentList = document.getElementById('documentList');
            documentList.innerHTML = '';
            
            if (documents && typeof documents === 'object') {
                Object.entries(documents).forEach(([title, filepath]) => {
                    const documentItem = document.createElement('div');
                    documentItem.className = 'document-item fade-in';
                    documentItem.innerHTML = `
                        <i class="fas fa-file-alt document-status-icon text-success"></i>
                        <span>${title}</span>
                        <a href="/download/${encodeURIComponent(filepath)}" class="btn btn-sm btn-outline-primary ms-auto">
                            <i class="fas fa-download"></i> Download
                        </a>
                    `;
                    documentList.appendChild(documentItem);
                });
                
                document.getElementById('documentRow').style.display = 'block';
            }
        }
        
        function showResults(data) {
            const resultsDiv = document.getElementById('results');
            
            if (data && data.saved_files) {
                let resultsHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Research and documentation generation completed successfully!</div>';
                
                resultsHTML += '<div class="row">';
                Object.entries(data.saved_files).forEach(([title, filepath]) => {
                    resultsHTML += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="fas fa-file-alt me-2"></i>${title}</h6>
                                    <a href="/download/${encodeURIComponent(filepath)}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                });
                resultsHTML += '</div>';
                
                resultsDiv.innerHTML = resultsHTML;
                document.getElementById('resultsSection').style.display = 'block';
            }
        }
        
        function loadConversations() {
            if (!currentSessionId) {
                console.log('No current session ID');
                return;
            }
            
            console.log('Loading conversations for session:', currentSessionId);
            
            fetch(`/conversations/${currentSessionId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Conversation data received:', data);
                    if (data.deepseek_messages || data.ollama_messages) {
                        console.log('DeepSeek messages:', data.deepseek_messages?.length || 0);
                        console.log('Ollama messages:', data.ollama_messages?.length || 0);
                        updateConversationLists(data);
                        document.getElementById('conversationRow').style.display = 'block';
                    } else {
                        console.log('No messages found yet');
                    }
                })
                .catch(error => {
                    console.error('Failed to load conversations:', error);
                });
        }
        
        function updateConversationLists(data) {
            // Update DeepSeek messages
            const deepseekList = document.getElementById('deepseekMessages');
            if (data.deepseek_messages && data.deepseek_messages.length > 0) {
                deepseekList.innerHTML = '';
                data.deepseek_messages.forEach(msg => {
                    const messageItem = createMessageItem(msg, 'deepseek');
                    deepseekList.appendChild(messageItem);
                });
            }
            
            // Update Ollama messages
            const ollamaList = document.getElementById('ollamaMessages');
            if (data.ollama_messages && data.ollama_messages.length > 0) {
                ollamaList.innerHTML = '';
                data.ollama_messages.forEach(msg => {
                    const messageItem = createMessageItem(msg, 'ollama');
                    ollamaList.appendChild(messageItem);
                });
            }
        }
        
        function createMessageItem(msg, llmType) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-item ${llmType} fade-in`;
            
            const timestamp = new Date(msg.timestamp);
            const timeString = timestamp.toLocaleTimeString();
            const dateString = timestamp.toLocaleDateString();
            
            messageDiv.innerHTML = `
                <div>
                    <span class="message-number ${llmType}">#${msg.number}</span>
                    <strong>${llmType === 'deepseek' ? 'DeepSeek' : 'Ollama'}</strong>
                    <span class="message-timestamp">${dateString} ${timeString}</span>
                </div>
                <div class="message-preview">${msg.preview}</div>
            `;
            
            // Add click handler to show full message
            messageDiv.onclick = () => showMessageModal(msg, llmType);
            
            return messageDiv;
        }
        
        function showMessageModal(msg, llmType) {
            const modal = new bootstrap.Modal(document.getElementById('messageModal'));
            
            document.getElementById('modalLLMName').textContent = llmType === 'deepseek' ? 'DeepSeek' : 'Ollama';
            document.getElementById('modalMessageNumber').textContent = msg.number;
            
            const timestamp = new Date(msg.timestamp);
            document.getElementById('modalTimestamp').textContent = 
                timestamp.toLocaleString();
            
            document.getElementById('modalMessageContent').textContent = msg.content;
            
            modal.show();
        }
        
        function pollStatus() {
            if (!currentSessionId || !isResearchActive) return;
            
            fetch(`/status/${currentSessionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status) {
                        updateLiveStatus(data.status.llm_name, data.status.activity, data.status.details);
                        updateMetrics(data);
                        
                        // Update stage progress indicator
                        if (data.session && data.session.current_stage) {
                            updateStageProgress(data.session.current_stage);
                        }
                        
                        // Check if completed
                        if (data.session && (data.session.completed || data.session.current_stage === 'completed')) {
                            isResearchActive = false;
                            updateLiveStatus('System', 'Research Completed!', 'All documents have been generated');
                            clearInterval(statusInterval);
                            
                            // Show completion banner
                            showCompletionBanner(data.session);
                            
                            // Fetch final results
                            fetch(`/session/${currentSessionId}`)
                                .then(response => response.json())
                                .then(sessionData => {
                                    if (sessionData.saved_files) {
                                        showResults(sessionData);
                                        updateDocumentStatus(sessionData.saved_files);
                                    }
                                })
                                .catch(console.error);
                        }
                        
                        // Load full conversation history periodically
                        if (data.session && data.session.message_count > 0) {
                            console.log('Session has', data.session.message_count, 'messages - loading conversations');
                            loadConversations();
                        }
                    }
                })
                .catch(error => {
                    console.error('Status polling error:', error);
                });
        }
        
        function updateStageProgress(currentStage, statusActivity = '') {
            // Map stage values to display names (NEW 11-stage workflow)
            const stageMapping = {
                'initial_breakdown': 'initial_breakdown',
                'discuss_breakdown': 'discuss_breakdown',
                'research': 'research',
                'analyze_research': 'analyze_research',
                'discuss_findings': 'discuss_findings',
                'deep_dive': 'deep_dive',
                'compile_information': 'compile_information',
                'discuss_compilation': 'discuss_compilation',
                'generate_documents': 'generate_documents',
                'refine_documents': 'refine_documents',
                'completed': 'completed'
            };
            
            const mappedStage = stageMapping[currentStage] || currentStage;
            
            // Get all stage items
            const stageItems = document.querySelectorAll('.stage-item');
            let foundCurrent = false;
            
            stageItems.forEach(item => {
                const itemStage = item.getAttribute('data-stage');
                const progressDetail = item.querySelector('.stage-progress-detail');
                
                if (itemStage === mappedStage) {
                    // Current stage
                    item.classList.add('active');
                    item.classList.remove('completed');
                    foundCurrent = true;
                    
                    // Update progress detail if available
                    if (progressDetail && statusActivity) {
                        // Extract meaningful info from status activity
                        const activityText = extractProgressInfo(statusActivity, itemStage);
                        if (activityText) {
                            progressDetail.textContent = activityText;
                            progressDetail.style.display = 'block';
                        }
                    }
                } else {
                    // Hide progress detail for non-active stages
                    if (progressDetail) {
                        progressDetail.style.display = 'none';
                    }
                    
                    if (!foundCurrent) {
                        // Past stages
                        item.classList.remove('active');
                        item.classList.add('completed');
                        // Show checkmark for completed stages
                        const number = item.querySelector('.stage-number');
                        if (number && !number.querySelector('i')) {
                            number.innerHTML = '<i class="fas fa-check"></i>';
                        }
                    } else {
                        // Future stages
                        item.classList.remove('active', 'completed');
                    }
                }
            });
        }
        
        function extractProgressInfo(activity, stage) {
            // Extract relevant progress information based on stage
            if (stage === 'research' && activity.includes('Searching')) {
                // Extract "Searching 5/18" type info
                return activity;
            } else if (stage === 'analyze_research') {
                // Show which source is being analyzed
                if (activity.includes('Processing source') || activity.includes('Analyzing')) {
                    return activity;
                }
            } else if (stage === 'deep_dive') {
                // Show dynamic search info
                if (activity.includes('Round') || activity.includes('search')) {
                    return activity;
                }
            }
            return '';
        }
        
        function showCompletionBanner(sessionData) {
            const banner = document.getElementById('completionBanner');
            if (!banner) return;
            
            // Update banner content
            const messageCount = sessionData.message_count || sessionData.all_messages?.length || 0;
            const searchCount = sessionData.research_metrics?.total_searches || 0;
            const docCount = sessionData.saved_files ? Object.keys(sessionData.saved_files).length : 0;
            
            document.getElementById('completionMessages').textContent = messageCount;
            document.getElementById('completionSearches').textContent = searchCount;
            document.getElementById('completionDocuments').textContent = docCount;
            
            // Show the banner with animation
            banner.style.display = 'block';
            setTimeout(() => {
                banner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }
        
        function startResearch() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                alert('Please enter a research prompt');
                return;
            }
            
            // Reset UI
            document.getElementById('llmStatusRow').style.display = 'block';
            document.getElementById('stageProgressRow').style.display = 'block';  // Show stage progress
            document.getElementById('progressRow').style.display = 'block';
            document.getElementById('timelineRow').style.display = 'block';
            document.getElementById('conversationRow').style.display = 'block';  // Show conversation lists
            document.getElementById('completionBanner').style.display = 'none';  // Hide completion banner initially
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('documentRow').style.display = 'none';
            
            console.log('UI reset - conversation row should be visible');
            
            // Disable button
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.innerHTML = '<div class="loading-spinner"></div>Starting Research...';
            
            isResearchActive = true;
            updateLiveStatus('System', 'Initializing research session', 'Preparing AI agents and research tools');
            
            fetch('/research', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ prompt: prompt })
            })
            .then(response => response.json())
            .then(data => {
                if (data.session_id) {
                    currentSessionId = data.session_id;
                    updateLiveStatus('System', 'Research session started', 'Beginning comprehensive analysis');
                    
                    // Start polling for status updates
                    statusInterval = setInterval(pollStatus, 2000); // Poll every 2 seconds
                    
                    // Enable button with different text
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-stop me-2"></i>Research Active';
                    startBtn.onclick = () => {
                        if (confirm('Are you sure you want to stop the research?')) {
                            stopResearch();
                        }
                    };
                } else {
                    alert('Failed to start research: ' + (data.error || 'Unknown error'));
                    resetUI();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error starting research: ' + error.message);
                resetUI();
            });
        }
        
        function stopResearch() {
            isResearchActive = false;
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
            updateLiveStatus('System', 'Research stopped by user');
            resetUI();
        }
        
        function resetUI() {
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-search me-2"></i>Start Research';
            startBtn.onclick = startResearch;
            isResearchActive = false;
            currentSessionId = null;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AI Research Dashboard initialized');
            updateLiveStatus('System', 'Ready', 'Enter a prompt to begin research');
        });
    </script>
</body>
</html>